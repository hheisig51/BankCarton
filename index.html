<html>

<head>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <style>
        table {
            margin: 0 auto;
            font-size: large;
            border: 1px solid black;
        }

        h1 {
            text-align: center;
            color: #006600;
            font-size: xx-large;
            font-family: 'Gill Sans',
                'Gill Sans MT', ' Calibri',
                'Trebuchet MS', 'sans-serif';
        }

        td {
            background-color: #E4F5D4;
            border: 1px solid black;
        }

        th,
        td {
            font-weight: bold;
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }

        td {
            font-weight: lighter;
        }
    </style>
    <script type="text/javascript">
        window.setTimeout(function () { document.location.reload(true); }, 31000);
    </script>

</head>

<body>
    <table id='table'>
        <!-- HEADING FORMATION -->
        <tr>
            <th>User</th>
            <th>Issue Title</th>
            <th>Label</th>
            <th>Urgency</th>
            <th>Creation Date</th>
        </tr>
    </table>
    <script>
        const TABLE_HEADERS = $("#table").html();
        const URGENCY_LABEL_MAP = {
            3938493162: "Gazelle"
        }; // mapping of urgency label ids to display names
        // add the others because I can't generate them atm
        const ISSUE_TYPE_MAP = {
            2371997559: "Help!"
        }; // issues w/o one of thsese labels will not be shown, use this to separate things like help from 3d printing etc
        function fillTable() {
            console.log("filling table with data");

            // FETCHING DATA FROM JSON FILE
            $.getJSON("https://api.github.com/repos/hheisig51/BankCarton/issues",
                function (data) {
                    console.log("got data");
                    $('#table').html(TABLE_HEADERS); //clear the previous data
                    var student = '';

                    // ITERATING THROUGH OBJECTS
                    $.each(data, function (key, value) {
                        // a number of label checks
                        let issue_type;
                        const type_labels = value.labels.filter(label => (Object.keys(ISSUE_TYPE_MAP).includes(label.id.toString())))
                        if(type_labels.length != 1){
                            // issue doesn't have exactly one type, ignore
                            console.log(`issue ${value.title} thrownout for bad issue type (elgible labels: ${Object.keys(ISSUE_TYPE_MAP)}, all labels: ${value.labels.map(val => [val.id, typeof val.id, val.name])})`)
                            return
                        } else {
                            issue_type = ISSUE_TYPE_MAP[type_labels[0].id]
                        }
                        let issue_urgency;
                        const urgency_labels = value.labels.filter(label => (Object.keys(URGENCY_LABEL_MAP).includes(label.id.toString())))
                        if(urgency_labels.length < 1){
                            // no label categorized as urgency
                            console.log(`issue ${value.title} has bad urgency (elgible urgencies: ${urgency_labels})`)
                            issue_urgency = ""
                        } else {
                            issue_urgency = URGENCY_LABEL_MAP[urgency_labels[0].id]
                        }
                        student += '<tr>';
                        student += '<td>' +
                            value.user.login + '</td>';

                        student += '<td>' +
                            value.title + '</td>';

                        student += '<td>' +
                            issue_type + '</td>';

                        student += '<td>' +
                            issue_urgency + '</td>';

                        student += '<td>' +
                            value.created_at + '</td>';

                        student += '</tr>';
                    });

                    //INSERTING ROWS INTO TABLE 
                    $('#table').append(student);
                });
        }
        
        setInterval(fillTable, 1000);

        $(document).ready(fillTable);
    </script>
</body>

</html>